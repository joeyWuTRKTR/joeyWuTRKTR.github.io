<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="这是一个副标题"><title>Geohash 計算點範圍的好工具</title><link rel=canonical href=https://example.com/2020/09/geohash/><link rel=stylesheet href=/scss/style.min.519f303bc7f74f3d2c30221a8b7bc24f3f9f260cd5b385faa5f4085c786e6bd2.css><meta property="og:title" content="Geohash 計算點範圍的好工具"><meta property="og:description" content="这是一个副标题"><meta property="og:url" content="https://example.com/2020/09/geohash/"><meta property="og:site_name" content="Joey Web Dev"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2020-09-10T00:00:00+00:00"><meta property="article:modified_time" content="2020-09-10T00:00:00+00:00"><meta name=twitter:title content="Geohash 計算點範圍的好工具"><meta name=twitter:description content="这是一个副标题"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huda2458f72ce188392d75c5d51cd8e24e_373_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Joey Web Dev</a></h1><h2 class=site-description>哈囉，歡迎來到Joey的開發技術部落格，紀錄演算法、地理空間模型、資料庫、Node.js，合作或私訊：godatascial@gmail.com，履歷：https://www.cakeresume.com/joey-wu-wen-jin</h2></div></header><ol class=social-menu><li><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#introduce-geohash->Introduce Geohash :</a><ol><li><ol><li><a href=#試玩看看geohash圖片可以點擊>試玩看看Geohash(圖片可以點擊)：</a></li></ol></li></ol></li><li><a href=#越多編碼數量範圍逐漸縮小>越多編碼數量，範圍逐漸縮小</a></li></ol><ol><li><ol><li><a href=#npm---ngeohash-httpswwwnpmjscompackagengeohash>npm - ngeohash: <a href=https://www.npmjs.com/package/ngeohash>https://www.npmjs.com/package/ngeohash</a></a></li><li><a href=#其他用法>其他用法：</a></li></ol></li></ol><ol><li><ol><li><a href=#原本的解法>原本的解法：</a></li><li><a href=#導入geohash後>導入Geohash後：</a></li></ol></li></ol><ol><li><a href=#1-減少查詢sql次數>1. 減少查詢SQL次數</a></li><li><a href=#2-提升sql查詢效率>2. 提升SQL查詢效率</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/test/ style=background-color:#2a9d8f;color:#fff>Test</a>
<a href=/categories/%E6%B5%8B%E8%AF%95/>测试</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/2020/09/geohash/>Geohash 計算點範圍的好工具</a></h2><h3 class=article-subtitle>这是一个副标题</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Sep 10, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>2 minute read</time></div></footer></div></header><section class=article-content><h2 id=introduce-geohash->Introduce Geohash :</h2><p>Geohash是一種編碼方式
將“經緯度座標”轉成由數字和英文字母所代表的“網格(Grid)”範圍</p><p>舉例來說：<br>台北101的座標(&ldquo;25.03463&rdquo;, &ldquo;121.56441&rdquo;)<br>在精度8的情況下會轉換成"wsqqqm2t"
<img src=/img/20230720-parking-lot-geohash/taipei101-coordinate-google-map.png loading=lazy alt=taipei101-coordinate-google-map.png></p><h4 id=試玩看看geohash圖片可以點擊>試玩看看Geohash(圖片可以點擊)：</h4><p>Sunny在哪？
Geek在哪？
<a class=link href=https://phrozen.github.io/geohash/ target=_blank rel=noopener><img src=/img/20230720-parking-lot-geohash/geohash-demo-tool.png loading=lazy alt=geohash-demo-tool.png></a></p><h2 id=越多編碼數量範圍逐漸縮小>越多編碼數量，範圍逐漸縮小</h2><p>精度1：面積：5,009.4km x 4,992.6km
<img src=/img/20230720-parking-lot-geohash/geohash-p-1.png loading=lazy alt=geohash-p-1.png></p><p>精度2：面積：1,252.3km x 624.1km
<img src=/img/20230720-parking-lot-geohash/geohash-p-2.png loading=lazy alt=geohash-p-2.png></p><p>精度3：面積：156.5km x 156km
<img src=/img/20230720-parking-lot-geohash/geohash-p-3.png loading=lazy alt=geohash-p-3.png></p><p>精度4：面積：39.1km x 19.5km
<img src=/img/20230720-parking-lot-geohash/geohash-p-4.png loading=lazy alt=geohash-p-4.png></p><p>精度5：面積：4.9km x 4.9km
<img src=/img/20230720-parking-lot-geohash/geohash-p-5.png loading=lazy alt=geohash-p-5.png></p><p>精度6：面積：1.2km x 609.4m
<img src=/img/20230720-parking-lot-geohash/geohash-p-6.png loading=lazy alt=geohash-p-6.png></p><p>精度7：面積：152.9m x 152.4m
<img src=/img/20230720-parking-lot-geohash/geohash-p-7.png loading=lazy alt=geohash-p-7.png></p><p>精度8：面積：38.2m x 19m
<img src=/img/20230720-parking-lot-geohash/geohash-p-8.png loading=lazy alt=geohash-p-8.png></p><h1 id=geohash-精度對應面積表>Geohash 精度對應面積表</h1><p>每個層級的解析度：</p><div class=table-wrapper><table><thead><tr><th>層級(Precision)</th><th>面積</th></tr></thead><tbody><tr><td>1</td><td>5,009.4km x 4,992.6km</td></tr><tr><td>2</td><td>1,252.3km x 624.1km</td></tr><tr><td>3</td><td>156.5km x 156km</td></tr><tr><td>4</td><td>39.1km x 19.5km</td></tr><tr><td>5</td><td>4.9km x 4.9km</td></tr><tr><td>6</td><td>1.2km x 609.4m</td></tr><tr><td>7</td><td>152.9m x 152.4m</td></tr><tr><td>8</td><td>38.2m x 19m</td></tr><tr><td>9</td><td>4.8m x 4.8m</td></tr><tr><td>10</td><td>1.2m x 59.5cm</td></tr><tr><td>11</td><td>14.9cm x 14.9cm</td></tr><tr><td>12</td><td>3.7cm x 1.9cm</td></tr></tbody></table></div><h1 id=計算原理>計算原理</h1><h1 id=node-geohash套件>Node Geohash套件</h1><h3 id=npm---ngeohash-httpswwwnpmjscompackagengeohash>npm - ngeohash: <a class=link href=https://www.npmjs.com/package/ngeohash target=_blank rel=noopener>https://www.npmjs.com/package/ngeohash</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>geohash</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;ngeohash&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 1. 將經緯度座標轉成Geohash
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>taipei101Geohash</span> <span class=o>=</span> <span class=nx>geohash</span><span class=p>.</span><span class=nx>encode</span><span class=p>(</span><span class=mf>25.03463</span><span class=p>,</span> <span class=mf>121.56441</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>taipei101Geohash</span><span class=p>);</span> <span class=c1>// wsqqqm2t2，默認層級九
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 2. 將Geohash轉成經緯度座標
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>taipei101LatLon</span> <span class=o>=</span> <span class=nx>geohash</span><span class=p>.</span><span class=nx>decode</span><span class=p>(</span><span class=nx>taipei101Geohash</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// Geohash轉回經緯度會有誤差
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>taipei101LatLon</span><span class=p>.</span><span class=nx>latitude</span><span class=p>);</span> <span class=c1>// 25.034644603729248
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>taipei101LatLon</span><span class=p>.</span><span class=nx>longitude</span><span class=p>);</span> <span class=c1>// 121.56442880630493
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 3. 找出Geohash周圍八個網格
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>taipei101GeohashNeighbors</span> <span class=o>=</span> <span class=nx>geohash</span><span class=p>.</span><span class=nx>neighbors</span><span class=p>(</span><span class=nx>taipei101Geohash</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>taipei101GeohashNeighbors</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// wsqqqm2t2 周圍的八個geohash網格
</span></span></span><span class=line><span class=cl><span class=c1>// [
</span></span></span><span class=line><span class=cl><span class=c1>//     &#39;wsqqqm2t8&#39;,
</span></span></span><span class=line><span class=cl><span class=c1>//     &#39;wsqqqm2t9&#39;,
</span></span></span><span class=line><span class=cl><span class=c1>//     &#39;wsqqqm2t3&#39;,
</span></span></span><span class=line><span class=cl><span class=c1>//     &#39;wsqqqm2t1&#39;,
</span></span></span><span class=line><span class=cl><span class=c1>//     &#39;wsqqqm2t0&#39;,
</span></span></span><span class=line><span class=cl><span class=c1>//     &#39;wsqqqm2mp&#39;,
</span></span></span><span class=line><span class=cl><span class=c1>//     &#39;wsqqqm2mr&#39;,
</span></span></span><span class=line><span class=cl><span class=c1>//     &#39;wsqqqm2mx&#39;
</span></span></span><span class=line><span class=cl><span class=c1>// ]
</span></span></span></code></pre></td></tr></table></div></div><h3 id=其他用法>其他用法：</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>geohash</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;ngeohash&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>taipei101Geohash</span> <span class=o>=</span> <span class=nx>geohash</span><span class=p>.</span><span class=nx>encode</span><span class=p>(</span><span class=mf>25.03463</span><span class=p>,</span> <span class=mf>121.56441</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>taipei101Geohash</span><span class=p>);</span> <span class=c1>// wsqq, 取層級四
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>taipei101GeohashNeighbors</span> <span class=o>=</span> <span class=nx>geohash</span><span class=p>.</span><span class=nx>neighbors</span><span class=p>(</span><span class=nx>taipei101Geohash</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>taipei101GeohashNeighbors</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// [
</span></span></span><span class=line><span class=cl><span class=c1>//   &#39;wsqr&#39;, &#39;wsqx&#39;,
</span></span></span><span class=line><span class=cl><span class=c1>//   &#39;wsqw&#39;, &#39;wsqt&#39;,
</span></span></span><span class=line><span class=cl><span class=c1>//   &#39;wsqm&#39;, &#39;wsqj&#39;,
</span></span></span><span class=line><span class=cl><span class=c1>//   &#39;wsqn&#39;, &#39;wsqp&#39;
</span></span></span><span class=line><span class=cl><span class=c1>// ]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 1. 找出周圍八個網格中指定位置的網格
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>neighbor</span> <span class=o>=</span> <span class=nx>geohash</span><span class=p>.</span><span class=nx>neighbor</span><span class=p>(</span><span class=nx>taipei101Geohash</span><span class=p>,</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;neighbor = &#39;</span><span class=p>,</span> <span class=nx>neighbor</span><span class=p>);</span> <span class=c1>// wsqr，最上面的八個網格
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 2. 找出Geohash網格周圍四個角落的經緯度
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>bbox</span> <span class=o>=</span> <span class=nx>geohash</span><span class=p>.</span><span class=nx>decode_bbox</span><span class=p>(</span><span class=s1>&#39;wsqq&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>bbox</span><span class=p>);</span> 
</span></span><span class=line><span class=cl><span class=c1>// 最小緯度、最小經度、最大緯度、最大經度
</span></span></span><span class=line><span class=cl><span class=c1>// [ 24.9609375, 121.2890625, 25.13671875, 121.640625 ]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 3. 找出範圍內的所有geohash網格
</span></span></span><span class=line><span class=cl><span class=c1>// 切到的會算進去嗎？
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>bboxes</span> <span class=o>=</span> <span class=nx>geohash</span><span class=p>.</span><span class=nx>bboxes</span><span class=p>(</span><span class=mf>25.1</span><span class=p>,</span> <span class=mf>121.6</span><span class=p>,</span> <span class=mf>25.2</span><span class=p>,</span> <span class=mf>121.7</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>bboxes</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 找wsqq下層級五的geohash網格
</span></span></span><span class=line><span class=cl><span class=c1>// [
</span></span></span><span class=line><span class=cl><span class=c1>//   &#39;wsqqz&#39;, &#39;wsqwb&#39;,
</span></span></span><span class=line><span class=cl><span class=c1>//   &#39;wsqwc&#39;, &#39;wsqrp&#39;,
</span></span></span><span class=line><span class=cl><span class=c1>//   &#39;wsqx0&#39;, &#39;wsqx1&#39;,
</span></span></span><span class=line><span class=cl><span class=c1>//   &#39;wsqrr&#39;, &#39;wsqx2&#39;,
</span></span></span><span class=line><span class=cl><span class=c1>//   &#39;wsqx3&#39;
</span></span></span><span class=line><span class=cl><span class=c1>// ]
</span></span></span></code></pre></td></tr></table></div></div><p><img src=/img/20230720-parking-lot-geohash/geo-decode-bbox.png loading=lazy alt=geo-decode-bbox.png>
周圍四個角落的經緯度</p><p><img src=/img/20230720-parking-lot-geohash/geo-bboxes.png loading=lazy alt=geo-bboxes.png>
周圍的八個Geohash網格</p><h1 id=工作上實際應用>工作上實際應用</h1><p>目前我們在全球各地擁有超過一萬個停車點
在非尖峰時刻資料庫的可以好好消化每一個Request
然而像上/下班的每日尖峰、演唱會等特殊情況，會有一堆人在同時尋找哪裡可以停車
這時候會高達每秒幾十/百個Request進來，Postgres無法即時算出資料，造成資料擁塞等待計算完回傳結果。</p><h3 id=原本的解法>原本的解法：</h3><p>在PostgreSQL用車輛經緯度計算，距離所有停車點橢圓球體5公里內的最近停車點<br><img src=/img/20230720-parking-lot-geohash/map-circle.png loading=lazy alt=map-circle.png>
（比對數萬個停車點）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>PostgreSQL:
</span></span><span class=line><span class=cl>SELECT ST_DistanceSpheroid(pos, ST_SetSRID(ST_MakePoint(#{lon}, #{lat}), 4326), &#39;SPHEROID[&#34;WGS 84&#34;,6378137,298.257223563]&#39;) as distance
</span></span><span class=line><span class=cl>FROM parking_lot_table
</span></span><span class=line><span class=cl>WHERE
</span></span><span class=line><span class=cl>  ST_DistanceSpheroid(pos, ST_SetSRID(ST_MakePoint(#{lon}, #{lat}), 4326), &#39;SPHEROID[&#34;WGS 84&#34;,6378137,298.257223563]&#39;) &lt; 5000 AND
</span></span><span class=line><span class=cl>  ORDER BY distance
</span></span><span class=line><span class=cl>LIMIT 1
</span></span></code></pre></td></tr></table></div></div><h3 id=導入geohash後>導入Geohash後：</h3><p>業務場景為取得車輛方圓5公里內最近的停車點，因此面積是 5km x 5km x pi = 78平方公里<br>因此選用層級五即可</p><ol><li>如果層級五有找到停車點（紅色區域，5km x 5km = 25平方公里），找到停車點->query</li><li>如果層級五沒有找到停車點，找同層級的其他八個區域（綠色區域），總面積達到225平方公里（25km2 x 9 = 225km2），找到停車點->query</li><li>如果層級五的九宮格都沒有找到，則沒有滿足條件的停車點
<img src=/img/20230720-parking-lot-geohash/map-geo.png loading=lazy alt=map-geo.png></li></ol><h1 id=結論>結論：</h1><h2 id=1-減少查詢sql次數>1. 減少查詢SQL次數</h2><p>首先可以判斷是否座標周圍有涵蓋目標座標（使用者周圍是否有停車點）</p><h2 id=2-提升sql查詢效率>2. 提升SQL查詢效率</h2><p>第二是可以依照網格層級決定篩選多少量級的資料
藉由判斷是否在自身geohash網格、周圍八個geohash網格，將篩選出的資料範圍縮小</p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/2020/09/test-chinese/><div class=article-image><img src=/2020/09/test-chinese/_hu45a5e3ad5e058da6a00650ed8fd40bea_15530_27040ddd7399aaf289c0ce70ee6592d9.jpg width=250 height=150 loading=lazy alt="Featured image of post Chinese Test" data-key=test-chinese data-hash="md5-RvYejqai34/Fvx0koXxEpg=="></div><div class=article-details><h2 class=article-title>Chinese Test</h2></div></a></article><article class=has-image><a href=/2019/03/emoji-support/><div class=article-image><img src=/2019/03/emoji-support/_huf941de4769045cdfa8c9ee7036519a2a_35369_36687b530fa140121781e790cfd060e7.jpg width=250 height=150 loading=lazy alt="Featured image of post Emoji Support" data-hash="md5-YBFrHM/IYy6aZffVHfPvwg=="></div><div class=article-details><h2 class=article-title>Emoji Support</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 Joey Web Dev</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>